{% extends 'layout.html' %}

{% block style %}
{% endblock %}
{% block content %}
<div class="p-4 sm:ml-64" id="article" data-article-id="{{ article_id }}">
    <div class="flex justify-between mb-2 mt-14 py-2 pl-4 dark:bg-gray-700 text-gray-900 dark:text-gray-400">
        <div class="inline-flex items-center">
            <p class="ml-4 text-4xl font-bold">Write a new article</p>
        </div>
        <div class="inline-flex items-center pr-4">
            <a href="/articles/save_draft" type="button" id="save-draft" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Save Draft</a>
            <button type="button" id="publish" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">Publish</button>
        </div>
    </div>


    <div class="text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:text-gray-400 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px">
            <li class="me-2">
                <a href="/articles/drafts" class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 rounded-t-lg active dark:text-blue-500 dark:border-blue-500" aria-current="page">Drafts</a>
            </li>
            <li class="me-2">
                <a href="/articles/published" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300">Published</a>
            </li>
        </ul>
    </div>

    <form id="article-details" method="post" enctype="multipart/form-data" class="grid grid-cols-1 gap-4 rounded-lg dark:border-gray-700  divide-gray-200 mt-8 dark:divide-gray-700">
        <div>
            <label for="title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title</label>
            <input type="text" id="title" maxlength="50" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Title" required />
            <div class="inline-flex mt-1 text-sm text-gray-500 dark:text-gray-300" ><div id="title-count">0</div>/50</div>
        </div>
        <div>
            <label for="description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Short Description</label>
            <textarea id="description" rows="3" maxlength="150" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Write a short description here..."></textarea>
            <div class="inline-flex mt-1 text-sm text-gray-500 dark:text-gray-300" ><div id="description-count">0</div>/150</div>
        </div>
        <div>
            <label for="topics" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Topics</label>
            <input type="text" id="topics" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="" required />
        </div>
        <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="file_input">Thumbnail</label>
            <input  id="file_input" type="file" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" aria-describedby="file_input_help">
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-300" id="file_input_help">SVG, PNG, JPG or GIF (MAX. 800x400px).</p>
        </div>
        <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="content">Article Content</label>
            <textarea class="mt-8" id="content" name="content"></textarea>
        </div>

    </form>

</div>

{% endblock %}

{% block scripts %}
    <script>
        $("#publish").on('click', function(){
            var oldDir = '/static/uploads/'

             var content = tinymce.get('content').getContent();
            {#var updated_content = $(content).find('img').each(function(){#}
            {#    var imgName = $(this).attr("src").replace(oldDir, "").split('?')[0]#}
            {#    // replace src with jinja variable#}
            {#    var newImgName = {% raw %}'{{ image["' + imgName + '"] }}'{% endraw %}#}
            {#   $(this).attr("src", newImgName)#}
            {# }) #}
            {#console.log(updated_content)#}

            var form_data = new FormData()
            form_Data.append('articleId', $('#article').data('article-id'))
            form_data.append('title', $('#title').val())
            form_data.append('description', $('#description').val())
            form_data.append('topics', $('topics').val())
            form_data.append('thumbnail', $('#file_input').prop('files')[0])
            form_data.append('content', content )

            $.ajax({
                type: 'POST',
                url: '/articles/publish',
                data: form_data,
                 contentType: false,
                 cache: false,
                 processData: false,
                success: function(data){
                    console.log('Success!')
                }
            })
        })
    </script>
    <script type="text/javascript">
        const example_image_upload_handler = (blobInfo, progress) => new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', '{{ url_for('upload_image') }}'); // change this

                xhr.upload.onprogress = (e) => {
                    progress(e.loaded / e.total * 100);
                };

                xhr.onload = () =>  {
                    if (xhr.status === 403) {
                      reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
                      return;
                    }

                    if (xhr.status < 200 || xhr.status >= 300) {
                      reject('HTTP Error: ' + xhr.status);
                      return;
                    }

                    const json = JSON.parse(xhr.responseText);

                    if (!json || typeof json.location != 'string') {
                         failure('Invalid JSON: ' + xhr.responseText);
                         return;
                    }

                    resolve(json.location);
                };

                xhr.onerror = () => {
                    reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
                };

                const formData = new FormData();
                formData.append('image', blobInfo.blob(), blobInfo.filename());
                formData.append('articleId', $('#article').data('article-id'))
                formData.append('csrf_token', '{{csrf_token()}}'); // i add csrf_token

                xhr.send(formData);
            })

        tinymce.init({
            selector: '#content',
            height: 600,
            browser_spellcheck: true,
            contextmenu: false,
            plugins: [
                'advlist', 'autolink', 'link', 'image', 'lists', 'charmap', 'preview', 'anchor', 'pagebreak',
                'searchreplace', 'wordcount', 'visualblocks', 'visualchars', 'code', 'fullscreen', 'insertdatetime', 'media', 'nonbreaking',
                'save', 'table', 'directionality', 'codesample'
            ],

            toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons | codesample',
            relative_urls: false,
            images_upload_handler : example_image_upload_handler,
            images_upload_base_path: '/',
            image_title: true,
            automatic_uploads: true,
            images_reuse_filename: true,
            codesample_languages: [
                { text: 'HTML/XML', value: 'markup' },
                { text: 'JavaScript', value: 'javascript' },
                { text: 'CSS', value: 'css' },
                { text: 'Processing', value: 'processing' },
                { text: 'Python', value: 'python' }
            ],
            width: "100%",
            file_picker_types: 'image',
              /* and here's our custom image picker*/
              file_picker_callback: (cb, value, meta) => {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');

                input.addEventListener('change', (e) => {
                  const file = e.target.files[0];

                  const reader = new FileReader();
                  reader.addEventListener('load', () => {
                    /*
                      Note: Now we need to register the blob in TinyMCEs image blob
                      registry. In the next release this part hopefully won't be
                      necessary, as we are looking to handle it internally.
                    */
                    const id = 'blobid' + (new Date()).getTime();
                    const blobCache =  tinymce.activeEditor.editorUpload.blobCache;
                    const base64 = reader.result.split(',')[1];
                    const blobInfo = blobCache.create(id, file, base64);
                    blobCache.add(blobInfo);

                    /* call the callback and populate the Title field with the file name */
                    cb(blobInfo.blobUri(), { title: file.name });
                  });
                  reader.readAsDataURL(file);
                });

                input.click();
              },
              content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }'
        });
    </script>
{% endblock %}